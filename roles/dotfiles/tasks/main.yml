---
# Set home directory once for use throughout
# Use ~ which Ansible expands to the remote user's home directory
- name: "[ðŸ”— dotfiles] Get remote home directory"
  tags: [always, dotfiles]
  ansible.builtin.command:
    cmd: echo ~
  register: _home_dir_result
  changed_when: false

- name: "[ðŸ”— dotfiles] Set home directory fact"
  tags: [always, dotfiles]
  ansible.builtin.set_fact:
    _home_dir: "{{ _home_dir_result.stdout }}"

# Clean up dead symlinks recursively (run once across all profiles)
- name: "[ðŸ”— dotfiles] Run cleanup once"
  when: _dotfiles_cleanup_done is not defined
  tags: [always, dotfiles]
  block:
    - name: "[ðŸ”— dotfiles] Ensure ~/.config directory exists"
      ansible.builtin.file:
        path: "{{ _home_dir }}/.config"
        state: directory
        mode: "0755"

    - name: "[ðŸ”— dotfiles] Ensure ~/.local/bin exists"
      ansible.builtin.file:
        path: "{{ _home_dir }}/.local/bin"
        state: directory
        mode: "0755"

    - name: "[ðŸ”— dotfiles] Clean dead symlinks in home directory (depth 1)"
      ansible.builtin.include_tasks: cleanup_recursive.yml
      vars:
        cleanup_dir: "{{ _home_dir }}"
        max_depth: 1

    # Discover nested dotfiles directories (like claude/, vim/) from all profiles
    # and clean them with configurable depth. Excludes 'config' (handled separately).
    - name: "[ðŸ”— dotfiles] Discover nested dotfiles directories from all profiles"
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          find {{ playbook_dir }}/profiles/*/files/dotfiles -mindepth 1 -maxdepth 1 -type d 2>/dev/null \
            | xargs -I{} basename {} \
            | sort -u \
            | grep -v '^config$'
        executable: /bin/bash
      register: _nested_dotfiles_dirs
      changed_when: false
      failed_when: false

    - name: "[ðŸ”— dotfiles] Clean dead symlinks in nested dotfiles directories"
      ansible.builtin.include_tasks: cleanup_recursive.yml
      loop: "{{ _nested_dotfiles_dirs.stdout_lines | default([]) }}"
      loop_control:
        loop_var: _nested_dir
      vars:
        cleanup_dir: "{{ _home_dir }}/.{{ _nested_dir }}"
        max_depth: "{{ dotfiles_cleanup_depth }}"

    - name: "[ðŸ”— dotfiles] Clean dead symlinks in ~/.config"
      ansible.builtin.include_tasks: cleanup_recursive.yml
      vars:
        cleanup_dir: "{{ _home_dir }}/.config"
        max_depth: "{{ dotfiles_cleanup_depth }}"

    - name: "[ðŸ”— dotfiles] Clean dead symlinks in ~/.local/bin"
      ansible.builtin.include_tasks: cleanup_recursive.yml
      vars:
        cleanup_dir: "{{ _home_dir }}/.local/bin"
        max_depth: 1

    # Clean up dead symlinks in skill and agent folders (if configured)
    - name: "[ðŸ”— dotfiles] Aggregate skill_folders for cleanup"
      ansible.builtin.set_fact:
        _cleanup_skill_folders: "{{ lookup('aggregated_profile_var', 'skill_folders') | flatten | unique | list }}"
      when: _dotfiles_cleanup_done is not defined

    - name: "[ðŸ”— dotfiles] Aggregate agent_folders for cleanup"
      ansible.builtin.set_fact:
        _cleanup_agent_folders: "{{ lookup('aggregated_profile_var', 'agent_folders') | flatten | unique | list }}"
      when: _dotfiles_cleanup_done is not defined

    - name: "[ðŸ”— dotfiles] Clean dead symlinks in skill folders"
      ansible.builtin.include_tasks: cleanup_recursive.yml
      loop: "{{ _cleanup_skill_folders | default([]) }}"
      loop_control:
        label: "{{ item }}"
      vars:
        cleanup_dir: "{{ item | expanduser }}"
        max_depth: "{{ dotfiles_cleanup_depth }}"
      when: _cleanup_skill_folders | default([]) | length > 0

    - name: "[ðŸ”— dotfiles] Clean dead symlinks in agent folders"
      ansible.builtin.include_tasks: cleanup_recursive.yml
      loop: "{{ _cleanup_agent_folders | default([]) }}"
      loop_control:
        label: "{{ item }}"
      vars:
        cleanup_dir: "{{ item | expanduser }}"
        max_depth: "{{ dotfiles_cleanup_depth }}"
      when: _cleanup_agent_folders | default([]) | length > 0

    - name: "[ðŸ”— dotfiles] Mark cleanup as done"
      ansible.builtin.set_fact:
        _dotfiles_cleanup_done: true

# Symlink dotfiles recursively (file-level by default, directory-level with marker)
- name: "[ðŸ”— dotfiles] Symlink dotfiles to home directory"
  ansible.builtin.include_tasks: symlink_recursive.yml
  vars:
    source_dir: "{{ dotfiles_dir }}"
    target_dir: "{{ _home_dir }}"
    prefix: "."
    exclude_dirs:
      - config

- name: "[ðŸ”— dotfiles] Symlink config dotfiles to ~/.config"
  ansible.builtin.include_tasks: symlink_recursive.yml
  vars:
    source_dir: "{{ dotfiles_dir }}/config"
    target_dir: "{{ _home_dir }}/.config"
    prefix: ""

- name: "[ðŸ”— dotfiles] Check if dotfiles-to-copy directory exists"
  ansible.builtin.stat:
    path: "{{ dotfiles_copy_dir }}"
  register: dotfiles_copy_dir_check

- name: "[ðŸ”— dotfiles] Copy dotfiles"
  when: |
    dotfiles_copy_dir_check.stat.exists and dotfiles_copy_dir_check.stat.isdir
    and not ansible_check_mode
  block:
    - name: "[ðŸ”— dotfiles] Get list of files to copy"
      ansible.builtin.find:
        paths: "{{ dotfiles_copy_dir }}"
        file_type: any
        recurse: false
        hidden: true
      register: dotfiles_to_copy

    # For directories, add trailing slash to src so Ansible copies contents
    # instead of the directory itself (which would nest it inside dest)
    - name: "[ðŸ”— dotfiles] Copy files and directories"
      ansible.builtin.copy:
        src: "{{ item.path }}{{ '/' if item.isdir else '' }}"
        dest: "{{ _home_dir }}/.{{ item.path | basename }}"
        remote_src: true
        force: false
        mode: preserve
      loop: "{{ dotfiles_to_copy.files }}"
      loop_control:
        label: "{{ item.path | basename }}"

- name: "[ðŸ”— dotfiles] Symlink bin scripts to ~/.local/bin"
  ansible.builtin.include_tasks: symlink_recursive.yml
  vars:
    source_dir: "{{ bin_dir }}"
    target_dir: "{{ _home_dir }}/.local/bin"
    prefix: ""

# Aggregate skill_folders and agent_folders from all profiles
- name: "[ðŸ”— dotfiles] Aggregate skill_folders from all profiles"
  ansible.builtin.set_fact:
    _aggregated_skill_folders: "{{ lookup('aggregated_profile_var', 'skill_folders') | flatten | unique | list }}"
  tags: [always, dotfiles]

- name: "[ðŸ”— dotfiles] Aggregate agent_folders from all profiles"
  ansible.builtin.set_fact:
    _aggregated_agent_folders: "{{ lookup('aggregated_profile_var', 'agent_folders') | flatten | unique | list }}"
  tags: [always, dotfiles]

# Symlink skills from current profile to all configured destinations
- name: "[ðŸ”— dotfiles] Symlink skills to agent folders"
  when: _aggregated_skill_folders | length > 0
  ansible.builtin.include_tasks: symlink_skills.yml
  vars:
    skill_folders: "{{ _aggregated_skill_folders }}"
  tags: [always, dotfiles]

# Symlink agents from current profile to all configured destinations
- name: "[ðŸ”— dotfiles] Symlink agents to agent folders"
  when: _aggregated_agent_folders | length > 0
  ansible.builtin.include_tasks: symlink_agents.yml
  vars:
    agent_folders: "{{ _aggregated_agent_folders }}"
  tags: [always, dotfiles]

# Process additional dotfiles directories from custom inventories
- name: "[ðŸ”— dotfiles] Process additional dotfiles directories"
  when: additional_dotfiles_dirs | length > 0
  block:
    - name: "[ðŸ”— dotfiles] Process each additional dotfiles directory"
      ansible.builtin.include_tasks: symlink_additional.yml
      loop: "{{ additional_dotfiles_dirs }}"
      loop_control:
        loop_var: extra_dotfiles_dir
