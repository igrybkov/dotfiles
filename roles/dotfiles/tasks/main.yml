---
# This role runs once on localhost (not per-profile) using aggregated variables.
# All profile source directories are collected via aggregated_profile_var lookups
# and passed to symlink-dotfiles in a single batch per target.

# Set home directory for use throughout
- name: "[ðŸ”— dotfiles] Get home directory"
  ansible.builtin.command:
    cmd: echo ~
  register: _home_dir_result
  changed_when: false

- name: "[ðŸ”— dotfiles] Set home directory fact"
  ansible.builtin.set_fact:
    _home_dir: "{{ _home_dir_result.stdout }}"

# Aggregate all source directories from all profiles upfront
- name: "[ðŸ”— dotfiles] Aggregate source directories from all profiles"
  ansible.builtin.set_fact:
    _all_dotfiles_dirs: "{{ lookup('aggregated_profile_var', 'dotfiles_dir') }}"
    _all_bin_dirs: "{{ lookup('aggregated_profile_var', 'bin_dir') }}"
    _all_skills_dirs: "{{ lookup('aggregated_profile_var', 'skills_dir') }}"
    _all_agents_dirs: "{{ lookup('aggregated_profile_var', 'agents_dir') }}"
    _all_additional_dirs: "{{ lookup('aggregated_profile_var', 'additional_dotfiles_dirs') | flatten | unique }}"
    _all_skill_folders: "{{ lookup('aggregated_profile_var', 'skill_folders') | flatten | unique }}"
    _all_agent_folders: "{{ lookup('aggregated_profile_var', 'agent_folders') | flatten | unique }}"
    _all_copy_dirs: "{{ lookup('aggregated_profile_var', 'dotfiles_copy_dir') }}"

# --- Cleanup dead symlinks ---

- name: "[ðŸ”— dotfiles] Ensure ~/.config directory exists"
  ansible.builtin.file:
    path: "{{ _home_dir }}/.config"
    state: directory
    mode: "0755"

- name: "[ðŸ”— dotfiles] Ensure ~/.local/bin exists"
  ansible.builtin.file:
    path: "{{ _home_dir }}/.local/bin"
    state: directory
    mode: "0755"

- name: "[ðŸ”— dotfiles] Clean dead symlinks in home directory (depth 1)"
  ansible.builtin.include_tasks: cleanup_recursive.yml
  vars:
    cleanup_dir: "{{ _home_dir }}"
    max_depth: 1

# Discover nested dotfiles directories (like claude/, vim/) from all profiles
# and clean them with configurable depth. Excludes 'config' (handled separately).
- name: "[ðŸ”— dotfiles] Discover nested dotfiles directories from all profiles"
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      find {{ playbook_dir }}/profiles/*/files/dotfiles -mindepth 1 -maxdepth 1 -type d 2>/dev/null \
        | xargs -I{} basename {} \
        | sort -u \
        | grep -v '^config$'
    executable: /bin/bash
  register: _nested_dotfiles_dirs
  changed_when: false
  failed_when: false

- name: "[ðŸ”— dotfiles] Clean dead symlinks in nested dotfiles directories"
  ansible.builtin.include_tasks: cleanup_recursive.yml
  loop: "{{ _nested_dotfiles_dirs.stdout_lines | default([]) }}"
  loop_control:
    loop_var: _nested_dir
  vars:
    cleanup_dir: "{{ _home_dir }}/.{{ _nested_dir }}"
    max_depth: "{{ dotfiles_cleanup_depth }}"

- name: "[ðŸ”— dotfiles] Clean dead symlinks in ~/.config"
  ansible.builtin.include_tasks: cleanup_recursive.yml
  vars:
    cleanup_dir: "{{ _home_dir }}/.config"
    max_depth: "{{ dotfiles_cleanup_depth }}"

- name: "[ðŸ”— dotfiles] Clean dead symlinks in ~/.local/bin"
  ansible.builtin.include_tasks: cleanup_recursive.yml
  vars:
    cleanup_dir: "{{ _home_dir }}/.local/bin"
    max_depth: 1

- name: "[ðŸ”— dotfiles] Clean dead symlinks in skill folders"
  ansible.builtin.include_tasks: cleanup_recursive.yml
  loop: "{{ _all_skill_folders }}"
  loop_control:
    label: "{{ item }}"
  vars:
    cleanup_dir: "{{ item | expanduser }}"
    max_depth: "{{ dotfiles_cleanup_depth }}"
  when: _all_skill_folders | length > 0

- name: "[ðŸ”— dotfiles] Clean dead symlinks in agent folders"
  ansible.builtin.include_tasks: cleanup_recursive.yml
  loop: "{{ _all_agent_folders }}"
  loop_control:
    label: "{{ item }}"
  vars:
    cleanup_dir: "{{ item | expanduser }}"
    max_depth: "{{ dotfiles_cleanup_depth }}"
  when: _all_agent_folders | length > 0

# --- Symlink dotfiles ---

# Symlink dotfiles â†’ home (all profiles at once)
- name: "[ðŸ”— dotfiles] Symlink dotfiles to home directory"
  ansible.builtin.include_tasks: symlink_recursive.yml
  vars:
    source_dirs: "{{ _all_dotfiles_dirs + _all_additional_dirs }}"
    target_dir: "{{ _home_dir }}"
    prefix: "."
    exclude_dirs:
      - config

# Symlink config â†’ ~/.config (all profiles at once)
- name: "[ðŸ”— dotfiles] Symlink config dotfiles to ~/.config"
  ansible.builtin.include_tasks: symlink_recursive.yml
  vars:
    source_dirs: "{{ (_all_dotfiles_dirs + _all_additional_dirs) | map('regex_replace', '$', '/config') | list }}"
    target_dir: "{{ _home_dir }}/.config"
    prefix: ""

# Symlink bin â†’ ~/.local/bin (all profiles at once)
- name: "[ðŸ”— dotfiles] Symlink bin scripts to ~/.local/bin"
  ansible.builtin.include_tasks: symlink_recursive.yml
  vars:
    source_dirs: "{{ _all_bin_dirs }}"
    target_dir: "{{ _home_dir }}/.local/bin"
    prefix: ""

# Symlink skills to each skill folder (all profile sources at once)
- name: "[ðŸ”— dotfiles] Ensure skill destination directories exist"
  ansible.builtin.file:
    path: "{{ item | expanduser }}"
    state: directory
    mode: "0755"
  loop: "{{ _all_skill_folders }}"
  loop_control:
    label: "{{ item }}"
  when: _all_skill_folders | length > 0

- name: "[ðŸ”— dotfiles] Symlink skills to {{ item }}"
  ansible.builtin.include_tasks: symlink_recursive.yml
  loop: "{{ _all_skill_folders }}"
  vars:
    source_dirs: "{{ _all_skills_dirs }}"
    target_dir: "{{ item | expanduser }}"
    prefix: ""
  when: _all_skill_folders | length > 0

# Symlink agents to each agent folder (all profile sources at once)
- name: "[ðŸ”— dotfiles] Ensure agent destination directories exist"
  ansible.builtin.file:
    path: "{{ item | expanduser }}"
    state: directory
    mode: "0755"
  loop: "{{ _all_agent_folders }}"
  loop_control:
    label: "{{ item }}"
  when: _all_agent_folders | length > 0

- name: "[ðŸ”— dotfiles] Symlink agents to {{ item }}"
  ansible.builtin.include_tasks: symlink_recursive.yml
  loop: "{{ _all_agent_folders }}"
  vars:
    source_dirs: "{{ _all_agents_dirs }}"
    target_dir: "{{ item | expanduser }}"
    prefix: ""
  when: _all_agent_folders | length > 0

# --- Copy dotfiles (non-symlink, aggregated from all profiles) ---

- name: "[ðŸ”— dotfiles] Copy dotfiles from each profile"
  ansible.builtin.include_tasks: copy_dotfiles.yml
  loop: "{{ _all_copy_dirs }}"
  loop_control:
    loop_var: _copy_dir
