---
# Recursively symlink files from source directories to target directory
# Uses Python script for fast batch operations
#
# Parameters:
#   source_dirs: List of source directories to process (required, later dirs override earlier)
#   target_dir: Target directory for symlinks (required)
#   prefix: Prefix for target filenames, e.g., "." for home dir dotfiles (default: "")
#   exclude_dirs: List of top-level directory names to exclude (default: [])

- name: "[ðŸ”— dotfiles] Create symlinks using symlink-dotfiles"
  ansible.builtin.command:
    cmd: >
      {{ dotfiles_symlink_command }}
      {% for dir in source_dirs %}
      --source "{{ dir }}"
      {% endfor %}
      --target "{{ target_dir }}"
      --prefix "{{ prefix | default('') }}"
      {% for dir in exclude_dirs | default([]) %}
      --exclude "{{ dir }}"
      {% endfor %}
      --marker "{{ dotfiles_directory_marker }}"
      --json
  register: symlink_result
  changed_when: (symlink_result.stdout | from_json).changed
  failed_when: false

- name: "[ðŸ”— dotfiles] Report symlink results"
  vars:
    _result: "{{ symlink_result.stdout | from_json }}"
  ansible.builtin.debug:
    msg: >-
      Created: {{ _result.created }},
      Updated: {{ _result.updated }},
      Skipped: {{ _result.skipped }}
  when: symlink_result.stdout is defined and (symlink_result.stdout | trim | length > 0)

- name: "[ðŸ”— dotfiles] Fail on symlink conflicts"
  vars:
    _result: "{{ symlink_result.stdout | from_json }}"
    _conflicts: "{{ _result.conflicts }}"
    _backup_dir: "~/dotfiles-backup-{{ ansible_date_time.iso8601_basic_short }}"
  ansible.builtin.fail:
    msg: |

      Conflict: {{ _conflicts | length }} existing file(s) would be overwritten by symlinks:
      {% for f in _conflicts %}
        - {{ f }}
      {% endfor %}

      These are regular files, not symlinks. This typically happens on first run
      when the system already has default config files (e.g. ~/.bashrc, ~/.gitconfig).

      To fix, backup and remove the conflicting files, then re-run:

        mkdir -p {{ _backup_dir }}
        mv {{ _conflicts | join(' ') }} {{ _backup_dir }}/
        dotfiles install dotfiles
  when:
    - symlink_result.stdout is defined
    - (symlink_result.stdout | trim | length > 0)
    - _result.conflicts | length > 0

- name: "[ðŸ”— dotfiles] Fail on symlink errors"
  vars:
    _result: "{{ symlink_result.stdout | from_json }}"
  ansible.builtin.fail:
    msg: "Symlink errors: {{ _result.errors | join(', ') }}"
  when:
    - symlink_result.stdout is defined
    - (symlink_result.stdout | trim | length > 0)
    - _result.errors | length > 0
