# gitconfig

Ansible role to manage Git configuration using a conf.d fragment pattern.

## Description

This role manages profile-specific Git configuration by symlinking `*.gitconfig` fragment files from each profile into `~/.config/git/conf.d/`. It generates an `includes.gitconfig` that the main `~/.gitconfig` includes, providing ordered, profile-based git configuration.

It also aggregates `gitignore` files from all profiles into a single `~/.config/git/gitignore`.

## How It Works

```
~/.gitconfig (symlink -> profiles/common/files/dotfiles/gitconfig)
  └─ [include] path = ~/.gitconfig.local               # manual overrides
  └─ [include] path = ~/.config/git/conf.d/includes.gitconfig  # generated
       └─ [include] path = 0150-common-gitconfig.gitconfig
       └─ [include] path = 0800-personal-private-gitconfig.gitconfig

~/.config/git/conf.d/
  ├─ includes.gitconfig                                # GENERATED by role
  ├─ 0150-common-gitconfig.gitconfig                   # SYMLINK -> repo
  └─ 0800-personal-private-gitconfig.gitconfig          # SYMLINK -> repo

~/.config/git/gitignore                                # GENERATED: concatenation
```

Git processes `[include]` files in order. Later values override earlier ones for the same key. So higher-priority profiles (e.g., personal at 800) override lower-priority ones (e.g., common at 150).

Since fragments are symlinked, editing a fragment file in the repo immediately takes effect without re-running Ansible. Only adding or removing fragments requires a re-run (to regenerate `includes.gitconfig`).

## Requirements

- Git must be installed
- The main `~/.gitconfig` should include `~/.config/git/conf.d/includes.gitconfig`:
  ```gitconfig
  [include]
      path = ~/.config/git/conf.d/includes.gitconfig
  ```

## Tags

- `gitconfig` - Git configuration operations

## Role Variables

### `gitconfig_conf_d`

Path to the conf.d directory for git config fragments.

```yaml
gitconfig_conf_d: ~/.config/git/conf.d  # Default
```

### `gitconfig_includes_file`

Path to the generated includes file.

```yaml
gitconfig_includes_file: ~/.config/git/conf.d/includes.gitconfig  # Default
```

### `gitignore_file`

Path to the aggregated global gitignore file.

```yaml
gitignore_file: ~/.config/git/gitignore  # Default
```

## Profile Fragment Structure

Each profile can provide git config fragments and a gitignore file:

```
profiles/{name}/files/gitconfig/
  ├─ gitconfig.gitconfig    # Main git config fragment
  ├─ aliases.gitconfig       # Optional: additional fragments
  └─ gitignore               # Optional: gitignore patterns
```

### Fragment Naming in conf.d

Fragments are symlinked with priority-prefixed names:

```
{priority:04d}-{profile_name}-{original_filename}
```

Examples:
```
0150-common-gitconfig.gitconfig
0300-agents-gitconfig.gitconfig
0800-personal-private-gitconfig.gitconfig
```

Multiple fragments per profile are sorted alphabetically within the same priority.

## Example Usage

### Adding git config to a profile

Create `profiles/work/files/gitconfig/gitconfig.gitconfig`:

```gitconfig
[user]
    email = work@company.com
    name = John Doe (Work)

[includeIf "hasconfig:remote.*.url:git@github.com:company/**"]
    path = ~/.config/git/company.gitconfig
```

### Adding gitignore patterns

Create `profiles/work/files/gitconfig/gitignore`:

```gitignore
# Work-specific ignores
.internal-tools/
```

### Multiple fragments per profile

```
profiles/work/files/gitconfig/
  ├─ 00-identity.gitconfig    # User identity
  ├─ 10-aliases.gitconfig      # Work-specific aliases
  └─ gitignore                  # Work gitignore patterns
```

## Side Effects

- Creates `~/.config/git/conf.d/` directory
- Symlinks fragment files into conf.d
- Generates `~/.config/git/conf.d/includes.gitconfig`
- Generates `~/.config/git/gitignore` from all profile gitignore files
- Removes dead symlinks from conf.d
- Removes legacy `~/.config/git/local.gitconfig` if present
