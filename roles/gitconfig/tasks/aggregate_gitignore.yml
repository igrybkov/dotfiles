---
# Aggregate gitignore files from all profiles into a single file
# Reads from _gitignore_sources (sorted by priority)

- name: "[ðŸ”§ gitconfig] Ensure gitignore directory exists"
  ansible.builtin.file:
    path: "{{ gitignore_file | dirname }}"
    state: directory
    mode: "0755"

- name: "[ðŸ”§ gitconfig] Read gitignore content from each profile"
  ansible.builtin.slurp:
    path: "{{ item.path }}"
  register: _gitignore_contents
  loop: "{{ _gitignore_sources | sort(attribute='priority') }}"

# yamllint disable rule:line-length
- name: "[ðŸ”§ gitconfig] Write aggregated gitignore"
  ansible.builtin.copy:
    # yamllint disable-line rule:indentation
    content: "# Auto-generated by gitconfig role - do not edit manually\n# Aggregated from profile gitignore files\n{% for result in _gitignore_contents.results | default([]) %}\n# --- {{ result.item.profile }} (priority {{ result.item.priority }}) ---\n{{ result.content | b64decode }}\n{% endfor %}"
    dest: "{{ gitignore_file }}"
    mode: "0644"
  when: _gitignore_sources | length > 0
# yamllint enable rule:line-length

- name: "[ðŸ”§ gitconfig] Remove gitignore if no sources"
  ansible.builtin.file:
    path: "{{ gitignore_file }}"
    state: absent
  when: _gitignore_sources | length == 0
