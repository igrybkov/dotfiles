---
# SSH Config role - Main Tasks
# Variables are passed from the playbook (pre-aggregated from all profiles)
# Input validation is handled by argument_specs in meta/argument_specs.yml

- name: "[ðŸ” ssh] Set ssh config file path"
  ansible.builtin.set_fact:
    ssh_config_file: "{{ ssh_config_file | default('~/.ssh/config') }}"

- name: "[ðŸ” ssh] Get sorted profile hosts"
  ansible.builtin.set_fact:
    _profile_hosts: "{{ lookup('aggregated_profile_var', '_hosts') }}"

# Clean up old per-profile markers (migration from previous implementation)
- name: "[ðŸ” ssh] Clean up legacy per-profile markers"
  ansible.builtin.include_tasks: cleanup_legacy.yml

- name: "[ðŸ” ssh] Ensure SSH config directory exists"
  ansible.builtin.file:
    path: "{{ ssh_config_file | dirname }}"
    state: directory
    mode: "0755"

# yamllint disable rule:line-length
- name: "[ðŸ” ssh] Add top SSH config block"
  throttle: 1
  ansible.builtin.blockinfile:
    path: "{{ ssh_config_file }}"
    marker: "##### {mark} SSH CONFIG TOP #####"
    insertbefore: BOF
    create: true
    mode: "0644"
    block: "{{ ssh_client_config_block | selectattr('position', 'equalto', 'top') | map(attribute='content') | join('\n') }}"
  when: ssh_client_config_block | selectattr('position', 'equalto', 'top') | list | length > 0

- name: "[ðŸ” ssh] Add bottom SSH config block"
  throttle: 1
  ansible.builtin.blockinfile:
    path: "{{ ssh_config_file }}"
    marker: "##### {mark} SSH CONFIG BOTTOM #####"
    insertafter: EOF
    create: true
    mode: "0644"
    block: "{{ ssh_client_config_block | selectattr('position', 'equalto', 'bottom') | map(attribute='content') | join('\n') }}"
  when: ssh_client_config_block | selectattr('position', 'equalto', 'bottom') | list | length > 0

# Add host entries from all profiles (go in middle section, preserved across runs)
- name: "[ðŸ” ssh] Add hosts to ssh config"
  throttle: 1
  community.general.ssh_config:
    ssh_config_file: "{{ ssh_config_file }}"
    host: "{{ item.host }}"
    hostname: "{{ item.hostname | default(omit) }}"
    port: "{{ item.port | default(omit) }}"
    remote_user: "{{ item.remote_user | default(omit) }}"
    identity_file: "{{ item.identity_file | default(omit) }}"
    identities_only: "{{ item.identities_only | default(omit) }}"
    proxycommand: "{{ item.proxycommand | default(omit) }}"
    proxyjump: "{{ item.proxyjump | default(omit) }}"
    forward_agent: "{{ item.forward_agent | default(omit) }}"
    dynamicforward: "{{ item.dynamicforward | default(omit) }}"
    state: "{{ item.state | default(omit) }}"
    strict_host_key_checking: "{{ item.strict_host_key_checking | default(omit) }}"
    user_known_hosts_file: "{{ item.user_known_hosts_file | default(omit) }}"
    add_keys_to_agent: "{{ item.add_keys_to_agent | default(omit) }}"
    other_options: "{{ item.other_options | default(omit) }}"
  loop: "{{ ssh_client_config }}"
  when: ssh_client_config | length > 0
# yamllint enable rule:line-length
